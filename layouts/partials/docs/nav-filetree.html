<!-- Put configured sections list to .Scratch -->
{{ template "book-get-root-section" . }}

<ul>
  {{ range .Scratch.Get "BookSections" }}
    {{ template "book-section" (dict "Section" . "CurrentPage" $.Permalink) }}
  {{ end }}
</ul>

<!-- Single section of menu (recursive) -->
{{ define "book-section" }}
  <li {{ if .Section.Params.booktopsection }}class="book-nav-section"{{ end }}>

    {{ with .Section}}
      {{- if .Content -}}
        <a href="{{ .RelPermalink }}">{{- template "title" . -}}</a>
      {{- else -}}
        {{- template "title" . -}}
      {{- end -}}
    {{ end }}

    <ul>
      {{ range .Section.Sections }}
        {{ template "book-section" (dict "Section" . "CurrentPage" $.CurrentPage) }}
      {{ end }}
      {{ range .Section.Pages }}
        <li>
          <a href="{{ .RelPermalink }}" class="{{ if eq $.CurrentPage .Permalink }}active{{ end }}">
            {{- template "title" . -}}
          </a>
        </li>
      {{ end }}
    </ul>
  </li>
{{ end }}

{{ define "book-get-root-section" }}
  <!-- Complex logic to guess page title without .Title specified -->
  {{ $bookSection := default "docs" .Site.Params.BookSection  }}
  {{ if eq $bookSection "*" }}
    {{ .Scratch.Set "BookSections" .Site.Sections }}
  {{ else }}
    {{ $bookSections := where .Site.Sections "Section" $bookSection }}
    {{ .Scratch.Set "BookSections" $bookSections }}

    {{ if eq (len $bookSections) 1 }}
      {{ $singleSection := index $bookSections 0 }}
      {{ .Scratch.Set "BookSections" $singleSection.Sections }}
    {{ end }}
  {{ end }}
{{ end }}