{{ $bookSection := default "docs" .Site.Params.BookSection  }}
{{ if eq $bookSection "*" }}
  {{ .Scratch.Set "BookSections" .Site.Sections }}
{{ else }}
  {{ $bookSections := where .Site.Sections "Section" $bookSection }}
  {{ .Scratch.Set "BookSections" $bookSections }}

  {{ if eq (len $bookSections) 1 }}
    {{ $singleSection := index $bookSections 0 }}
    {{ .Scratch.Set "BookSections" $singleSection.Sections }}
  {{ end }}
{{ end }}

<ul>
  {{ range .Scratch.Get "BookSections" }}
    {{ template "book-section" (dict "Section" . "CurrentPage" $.Permalink) }}
  {{ end }}
</ul>

<!-- Single section of menu (recursive) -->
{{ define "book-section" }}
  <li {{ if .Section.Params.booktopsection }}class="book-nav-section"{{ end }}>
    {{ template "book-heading" .Section }}
    <ul>
      {{ range .Section.Sections }}
        {{ template "book-section" (dict "Section" . "CurrentPage" $.CurrentPage) }}
      {{ end }}
      {{ range .Section.Pages }}
        <li>
          <a href="{{ .RelPermalink }}" class="{{ if eq $.CurrentPage .Permalink }}active{{ end }}">
            {{ default .Title (.File | humanize | title) }}
          </a>
        </li>
      {{ end }}
    </ul>
  </li>
{{ end }}

<!-- Menu Heading -->
{{ define "book-heading" }}

  {{ $sections := split (trim .Dir "/") "/" }}
  {{ $title := index ($sections | last 1) 0 | humanize | title }}
  {{ $title := default .Title $title }}

  {{ if .Content }}
  <a href="{{ .RelPermalink }}">
    {{- $title -}} 
  </a>
  {{ else }}
  <a>
    {{- $title -}}
  </a>
  {{ end }}

{{ end }}
